<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" 
	"http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="pt" lang="pt">

<head>
    <title>Manual SliTaz (pt) - Hackeando LiveCD</title>
    <meta http-equiv="content-type" content="text/html; charset=ISO-8859-1" />
    <meta name="description" content="slitaz portuguese handbook" />
    <meta name="expires" content="never" />
    <meta name="modified" content="2008-07-20 06:08:00" />
    <meta name="publisher" content="www.slitaz.org" />
    <meta name="author" content="Christophe Lincoln" />
    <link rel="shortcut icon" href="favicon.ico" />
    <link rel="stylesheet" type="text/css" href="book.css" />
</head>
<body bgcolor="#ffffff" >

<!-- Header and quick navigation -->
<div id="header">
<div id="quicknav" align="right">
    <a name="top"></a>
    <a href="web-server.html">Servidor Web</a> |
    <a href="index.html">Conteúdo</a>
</div>
<h1><font color="#3e1220">Manual SliTaz (pt)</font></h1>
</div>

<!-- Content. -->
<div id="content">
<div class="content-right"></div>

<h2><font color="#df8f06">Hackeando o SliTaz LiveCD</font></h2>

<ul>
    <li><a href="hacking-livecd.html#intro">Introdução.</a></li>
    <li><a href="hacking-livecd.html#pre">Organização e Preparação.</a></li>
    <li><a href="hacking-livecd.html#add-files">Adicionando arquivos à ISO.</a></li>
    <li><a href="hacking-livecd.html#isolinux">Modificando a configuração do isolinux.</a></li>
    <li><a href="hacking-livecd.html#memtest">Instalando e usando o Memtest86.</a></li>
    <li><a href="hacking-livecd.html#rootfs">Manipulando o sistema root Live.</a></li>
    <li><a href="hacking-livecd.html#gen-iso">Gerando uma imagem ISO bootável com o isolinux.</a></li>
</ul>

<a name="intro"></a>
<h3>Introdução</h3>
<p>
<em>Hackeando o LiveCD</em> ou como se divertir manipulando a imagem ISO do LiveCD.
Note que você também pode <a href="gen-livecd.html">criar uma variação do LiveCD 
usando o Tazlito</a>. Criar as suas próprias imagens ISO bootáveis é fácil e os
passos para tal serão descritos cuidadosamente neste documento. A manipulação de
uma imagem ISO permite adicionar novos arquivos ou modificar os existentes no
LiveCD do SliTaz. A imagem ISO do SliTaz ocupa menos de 30 MB, ao passo que um 
CD-R ou CD-RW possui cerca de 700 MB, então há muito espaço para expansão. Por
exemplo, você pode armazenar suas imagens e até mesmo criar um slideshow <em>live</em>
usando o GQview. <em>Hackear</em> a imagem ISO permite modificar os arquivos de
configuração do gerenciador de boot,  imagens <em>splash</em> (mostradas durante
o processo de inicialização) e o próprio GRUB. Pode-se também adicionar o utilitário
Memtest86 (usado para testar a memória RAM do sistema). Com as mesmas técnicas é 
possível modificar o sistema de arquivos - o que requer manipulação extra e um
pouco mais de tempo.
</p>

<a name="pre"></a>
<h3>Organização e Preparação</h3>
<p>
Para começar, precisamos definir um local de trabalho, criando diretórios e diversos
subdiretórios que irão armazenar diferentes arquivos. O <em>hacking</em> da imagem
ISO pode ser feito utilizando-se o próprio SliTaz ou outra distribuição GNU/Linux,
como o Debian, Fedora, PCLInuxOS, etc. Se você utiliza o SliTaz como LiveCD 
(quando pode remover o cd assim que o sistema já foi carregado na memória RAM e
assim queimar uma nova ISO) é recomendável usar uma mídia USB para gravar os
diretórios de trabalho, caso contrário tudo o que for feito será perdido após
o desligamento do sistema. Comece criando um diretório para o <em>hacking</em> na raíz
de seu espaço de usuário, ou seja, o diretório <code>/home/slitaz</code> (na
versão estável do LiveCD). O uso de <code>/home/slitaz</code> permite o armazenamento
de uma imagem ISO original e dá a opção de criar um diretório <code>src/</code>
para o download de possíveis pacotes de fontes. Todos os estágios do <em>hacking</em>
pode ser feitos na linha de comando via um terminal X (Xterm) ou em modo console
no terminal Linux. Recomendamos que todos os comandos sejam executados pelo
usuário <em>root</em> para se evitar problemas relacionados à permissões. Para
se tornar <em>root</em> e criar o diretório <code>/home/slitaz/hacked</code>,
digite os comandos:
</p>
<pre> $ su
 # mkdir -p /home/slitaz/hacked
 (# mkdir -p /home/slitaz/src)
 # cd /home/slitaz/hacked
</pre>
<h4>Obtendo o conteúdo da ISO</h4>
<p>
Agora que você está no diretório de trabalho, deve criar a raíz da ISO modificada
e obter os arquivos da ISO original do SliTaz - o kernel Linux (<code>bzImage</code>),
o sistema de arquivos comprimido (<code>rootfs.gz</code>) e os arquivos do 
gerenciador de boot Isolinux. Para a obtenção destes arquivos há duas opções, de
um cdrom gravado ou de uma imagem ISO armazenada localmente. Para criar a raíz
do seu CD (<code>rootcd</code>) e copiar os arquivos de um cdrom que se encontra
em <code>/dev/cdrom</code> montado em <code>/media/cdrom</code>:
</p>
<pre> # mount -t iso9660 /dev/cdrom /media/cdrom
 # mkdir rootcd
 # cp -a /media/cdrom/* rootcd
</pre>
<p>
Para montar uma imagem ISO usando <em>loop</em> em um diretório temporário
<code>/tmp/loop</code> (usando a imagem <code>slitaz-cooking.iso</code>), criar
a raíz do CD (<code>rootcd</code>), copiar todos os arquivos e desmontar a imagem:
</p>
<pre> # mkdir /tmp/loop
 # mount -o loop slitaz-cooking.iso /tmp/loop
 # mkdir rootcd
 # cp -a /tmp/loop/* rootcd
 # umount /tmp/loop
</pre>
<p>
Voilà, todos os arquivos necessário devem estar agora presentes no diretório 
<code>rootcd</code>. Para ter certeza, você pode listar todos os arquivos 
recursivamente com o comando <code>ls</code>:
</p>
<pre> # ls -R rootcd
</pre>

<a name="add-files"></a>
<h3>Adicionando arquivos à ISO</h3>
<p>
A adição de vários arquivos e diretórios para a imagem ISO consiste simplesmente
em copiar os dados para a raíz do cdrom (<code>rootcd/</code>) e gerar uma nova
imagem. Os dados devem ser organizados em um ou dois diretórios criados na raíz
do CD. Uma vez que a imagem ISO for queimada para um CD-R/CD-RW você pode usar
o SliTaz como antes, montado em <code>/media/cdrom</code> e acessar os arquivos
com o emelFM2, Clex ou pela linha de comando. Seus dados poderão ser lidos por
qualquer sistema GNU/Linux, BSD ou até mesmo... Windows.
</p>
<h4>Criando diretórios e copiando dados</h4>
<p>
Para criar e copiar arquivos, você pode começar usando a linha de comando e então
continuar por meio de algum programa gráfico como um simples usuário. Nós iremos
criar um diretório <code>images/</code> como usuário <em>root</em> e então vamos
mudar as permissões para que todos os usuários tenham acesso de escrita:
</p>
<pre> # mkdir rootcd/images
 # chmod 777 rootcd/images
</pre>
<p>
Agora que o diretório existe e qualquer usuário pode escrever nele, você pode 
adicionar arquivos no diretório. Quando terminar você pode então 
<a href="hacking-livecd.html#gen-iso">gerar uma imagem ISO bootável</a>.
</p>

<a name="isolinux"></a>
<h3>Modificando a configuração do isolinux</h3>
<p>
A modificação do isolinux permite a criação de entradas customizadas por meio
dos parâmetros de <em>pre-boot</em>, por exemplo pode-se adicionar um
<code>label</code> que inicializa o SliTaz com as opções <code>lang=en</code>
e <code>kmap=en</code>. Pode-se também modificar o design, mudando-se a imagem
<em>splash</em> que é mostrada na inicialização. O aplicativo <code>isolinux</code>
gerencia o início do <em>gerenciador de boot</em> do LiveCD e é fornecido pelo
pacote Syslinux. O arquivo fonte do Syslinux fornece vários aplicativos que são
usados para inicializar um sistema GNU/Linux. O binário <code>isolinux.bin</code>
controla o carregamento do boot de fato. O gerenciador de boot é simples, rápido
e facilmente configurável tanto graficamente quanto usando um editor de texto. 
A síntaxe do arquivo de configuração <code>isolinux.cfg</code> é fácil de 
compreender - para adicionar novas entradas apenas copie e cole a partir do 
arquivo original. Para editar o arquivo usando o leafpad:
</p>
<pre> # leafpad rootcd/boot/isolinux/isolinux.cfg &amp;
</pre>
<h4>Arquivo de configuração isolinux.cfg</h4>
<p>
O arquivo <code>isolinux.cfg</code> encontrado na versão padrão do LiveCD do
SliTaz inicia com o valor <code>display</code>, que mostra tanto um arquivo de
texto quando um arquivo <code>isolinux.msg</code> que se utiliza de 24 caracteres
ASCII e uma imagem <em>splash</em>. O valor <code>default</code> define o nome da
<code>label</code> iniciada por padrão depois de dado período de tempo 
(<code>timeout</code>). <em>Timeout</em> é o número de segundos a esperar antes 
de bootar o sistema, pode-se utilizar o valor "0" para bootar o sistema imediatamente
ou um tempo de espera tão longo quanto "80" segundos. O <code>prompt</code> pode
ser desativado usando o valor <code>0</code>, F1, F2, F3 ativarão arquivos de 
ajuda e F4 mostra um arquivo de texto:
</p>
<pre class="script">display isolinux.msg
default slitaz
label slitaz
      kernel /boot/bzImage
      append initrd=/boot/rootfs.gz rw root=/dev/null vga=788
implicit 0	
prompt 1	
timeout 80
F1 help.txt
F2 options.txt
F3 isolinux.msg
F4 display.txt
</pre>
<p>
Exemplo de uma <em>label</em> <code>slitazen</code> na qual pode-se adicionar ao
arquivo original opções para configurar diretamente a linguagem do sistema para
inglês e usar o layout de teclado UK:
</p>
<pre class="script">label slitazen
      kernel /boot/bzImage
      append initrd=/boot/rootfs.gz rw root=/dev/null lang=en kmap=en
</pre>
<p>
Uma vez terminadas as modificações no arquivo de configuração, não se esqueça de
salvar suas mudanças e <a href="hacking-livecd.html#gen-iso">gerar uma imagem ISO bootável</a> 
com o isolinux.
</p>

<a name="memtest"></a>
<h3>Instalando e usando o Memtest86</h3>
<p>
O aplicativo memtest86 (92 kb) é uma ferramenta para testar a memória RAM do 
sistema. Ele faz testes profundos que, se falharem, apontam fortemente para uma
falha de hardware. A ferramenta se encontra no diretório <code>boot/</code> e
e pode ser iniciada diretamente digitando-se <code>memtest</code> no prompt do
isolinux. Vá até <code>/home/slitaz/src</code> (se o diretório não existir: 
<code>mkdir -p /home/slitaz/src</code>), faça o download do fonte e descompacte:
</p>
<pre> # cd /home/slitaz/src
 # wget http://www.memtest86.com/memtest86-3.3.tar.gz
 # tar xzf memtest86-3.3.tar.gz
</pre>
<p>
Ao descompactar o fonte do pacote memtest86 você encontrará o arquivo <code>README</code>
que fornece informações sobre a ferramenta. Agora você pode instalar o aplicativo
na <em>raíz do CD</em> de sua imagem ISO hackeada. Baseado na premissa de que
seu diretório de trabalho é <code>/home/slitaz/hacked</code>, vamos copiar o binário
pré-compilado para o diretório <code>boot/</code> na raíz do CD:
</p>
<pre> # cp memtest86-3.3/precomp.bin \
   /home/slitaz/hacked/rootcd/boot/memtest
</pre>
<p>
Agora que o binário está instalado na <em>raíz do CD</em>, podemos adicionar uma
entrada para o memtest86 no arquivo de configuração do isolinux e
<a href="hacking-livecd.html#gen-iso">gerar uma imagem ISO bootável</a>. Vá até
<code>/home/slitaz/hacked</code> e edite o arquivo <code>isolinux.cfg</code> 
usando o Leafpad:
</p>
<pre> # cd /home/slitaz/hacked
 # leafpad rootcd/boot/isolinux/isolinux.cfg &amp;
</pre>
<pre class="script">label memtest
      kernel /boot/memtest
</pre>
<p>
Website oficial do <a href="http://www.memtest86.com/">Memtest86</a>
</p>

<a name="rootfs"></a>
<h3>Manipulando o sistema root Live</h3>
<p>
Mudanças na raíz do sistema Live permitem a você, por exemplo, adicionar novos
usuários e senhas, customizar os gráficos ou executar comando automaticamente no
momento do boot. As operações necessárias para mudar o sistema de arquivos root são:
extrair o sistema de arquivos comprimido <code>rootfs.gz</code>, modificar, 
reconstruir a imagem e gerar a ISO. Baseado no pressuposto de que você
<a href="hacking-livecd.html#pre">preparou um diretório de trabalho</a>, iremos começar criando um
diretório para conter arquivos no sistema modificado. Como o sistema de 
arquivos comprimido é nomeado <code>rootfs.gz</code>, sugerimos que você 
utilize um diretório chamado <code>rootfs/</code> para extrai-lo. Vá até o diretório
<code>hacked/</code>, crie o diretório raiz e copie o sistema de arquivos comprimido
para <code>rootcd/boot/</code> (a raíz do cdrom):
</p>
<pre> # cd /home/slitaz/hacked
 # mkdir rootfs
 # cp rootcd/boot/rootfs.gz rootfs
</pre>
<p>
Agora que uma cópia do sistema de arquivos comprimido está em seu devido lugar,
apenas descomprima com o <code>cpio</code>. Tecnicamente, o <code>rootfs.gz</code>
é um arquivo cpio comprimido com lzma ou gzip. É reconhecido pelo kernel Linux 
como uma imagem <code>initramfs</code>. No momento em que a máquina é iniciada,
o kernel é carregado na memória e então descomprime a imagem do sistema e 
executa os scripts de inicialização.
</p>
<p>
Para extrair o sistema de arquivos para <code>rootfs/</code> e deletar a cópia
não arquivada (lembre-se que você pode copiar &amp; colar os comando):
</p>
<pre> # cd rootfs
 # (zcat rootfs.gz 2&gt;/dev/null || lzma d rootfs.gz -so) | cpio -id
 # rm rootfs rootfs.gz
</pre>
<p>
O sistema está pronto para ser hackeado, você pode listar todos os arquivos na
raíz de seu sistema usando o comando <code>ls</code>
</p>
<h4>Modificando um arquivo</h4>
<p>
Para manter as coisas simples a ajudar você a entender os princípios, nós vamos
mudar um script no intuito de executar alguns comandos automaticamente após o CD
inicializar o sistema. O alvo é o arquivo <code>etc/init.d/local.sh</code>, abra-o
com seu editor favorito, ou com o Geany:
</p>
<pre> # geany etc/init.d/local.sh &amp;
</pre>
<p>
Iremos adicionar um comando que mostra uma messagem e faz o sistema "dormir" por
4 segundos. Exemplo usando o script referido:
</p>
<pre class="script">echo "* Hacked SliTaz version booting..."
sleep 4
</pre>
<h4>Reconstruindo a imagem do sistema comprimido</h4>
<p>
Uma vez tendo feito as mudanças, pode-se reconstruir a imagem comprimida de seu
sistema usando o <code>find</code> para encontrar os arquivos, <code>cpio</code>
para arquivar, <code>lzma</code> e <code>gzip</code> para comprimir e o sinal de
"pipe" <code>|</code> para conectar todos os comandos. Isto deve ser feito a 
partir do sistema de arquivos raiz (<code>rootfs/</code>) e cria um arquivo
comprimido <code>rootfs.gz</code> no diretório precedente:
</p>
<pre> 
 # find . -print | cpio -o -H newc | lzma e -si -so &gt; ../rootfs.gz
 Ou com o gzip:
 # find . -print | cpio -o -H newc | gzip -9 &gt; ../rootfs.gz
</pre>
<p>
Finalmente copie o arquivo do sistema comprimido para o diretório <code>boot/</code>
na raíz do CD e <a href="hacking-livecd.html#gen-iso">gere uma imagem ISO bootável</a> com o 
isolinux. Para copiar o novo <em>rootfs</em> comprimido no diretório de trabalho:
</p>
<pre> 
 # cd ../
 # cp -a rootfs.gz rootcd/boot
</pre>

<a name="gen-iso"></a>
<h3>Gerando uma imagem ISO bootável</h3>
<p>
O seguinte comando cria uma imagem com o <em>gerenciador de boot</em>
<code>isolinux</code>, usando o aplicativo <code>genisoimage</code> com algumas
opções. O nome da ISO é especificado no começo, depois da opção <code>-o</code>
e o diretório raiz (<code>rootcd</code>) ao final, depois da opção
<code>-boot-info-table</code>:
</p>
<pre> 
   # genisoimage -R -o slitaz-hacked.iso -b boot/isolinux/isolinux.bin \
   -c boot/isolinux/boot.cat -no-emul-boot -boot-load-size 4 \
   -V "SliTaz-Hacked" -input-charset iso8859-1 -boot-info-table rootcd
</pre>
<p>
Se você quiser checar o conteúdo da imagem ISO antes de queimá-la num CD, apenas
monte a imagem em <code>loop</code> e liste os arquivos. No SliTaz e na maioria
das distribuições GNU/Linux, você pode queimar imagens em formato ISO para cd's
com o utilitário <code>wodim</code>.
</p>
<h4>Gere uma nova ISO a partir de um script</h4>
<p>
Se você quiser testar diversas novas possibilidades e gerar diversas imagens ISO,
pode querer também semi-automatizar o processo através de um simples SHell script.
Este pequeno script pode ser editado na linha de comando ou graficamente,
mas não se esqueça de fazê-lo executável. Você pode criar o script com o <code>cat</code>,
note que <code>EOF</code> significa <em>"End Of File"</em> (fim do arquivo). Para
criar o script <code>gen_hacked_iso.sh</code> usando duas variáveis para mudar
o nome da imagem ISO e o "path" (caminho) para o diretório raíz do cdrom:
</p>
<pre> # cat &gt; gen_hacked_iso.sh &lt;&lt; "EOF"</pre>
<pre class="script">#!/bin/sh
# Gera uma nova imagem ISO hackeada.
#
ISO_NAME="slitaz-hacked.iso"
ROOTCD="rootcd"

genisoimage -R -o $ISO_NAME -b boot/isolinux/isolinux.bin \
   -c boot/isolinux/boot.cat -no-emul-boot -boot-load-size 4 \
   -V "SliTaz-Hacked" -input-charset iso8859-1 -boot-info-table $ROOTCD

EOF
</pre>
<p>
Para usar o script, torne-o executável:
</p>
<pre> # chmod +x gen_hacked_iso.sh
 # ./gen_hacked_iso.sh
</pre>

<!-- End of content -->
</div>

<!-- Footer. -->
<div id="footer">
	<div class="footer-right"></div>
	<a href="hacking-livecd.html#top">Topo da Página</a> | 
	<a href="index.html">Conteúdo</a>
</div>

<div id="copy">
    Copyright © 2008 <a href="http://www.slitaz.org/pt/">SliTaz</a> -
    <a href="http://www.gnu.org/licenses/gpl.html">GNU General Public License</a>;<br />
    Documentation is under
    <a href="http://www.gnu.org/copyleft/fdl.html">GNU Free Documentation License</a>
    and code is <a href="http://validator.w3.org/">valid xHTML 1.0</a>.
</div>

</body>
</html>
