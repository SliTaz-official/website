<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
	"http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
	<title>SliTaz Cookbook (en) - Build Bot</title>
	<meta http-equiv="content-type" content="text/html; charset=ISO-8859-1" />
	<meta name="description" content="slitaz English cookbook" />
	<meta name="expires" content="never" />
	<meta name="modified" content="2009-06-20 00:10:00" />
	<meta name="publisher" content="www.slitaz.org" />
	<meta name="author" content="SliTaz contributors"/>
	<link rel="shortcut icon" href="favicon.ico" />
	<link rel="stylesheet" type="text/css" href="book.css" />
</head>
<body bgcolor="#ffffff">

<!-- Header and quick navigation -->
<div id="header">
<div align="right" id="quicknav">
	<a name="top"></a>
	<a href="boot-scripts.html">Boot scripts</a> |
	<a href="index.html">Table of contents</a>
</div>
<h1><font color="#3E1220">SliTaz Cookbook (en)</font></h1>
</div>

<!-- Content. -->
<div id="content">
<div class="content-right"></div>

<h2><font color="#DF8F06">Build Bot (tazbb)</font></h2>

<p>
The goal of Tazbb is to automate, test and report packages built inside a wok.
Run <code>tazbb usage</code> for the list of available commands with
a short description. 
The Status of the Tank Build Bot via a Tazbb web interface is at
<a href="http://bb.slitaz.org/">bb.slitaz.org</a> and for collaboration,
use the <a href="http://labs.slitaz.org/wiki/distro/Tazbb">Tazbb Wiki</a>.
</p>

<ul>
	<li><a href="index.html#about">How it works</a></li>
	<li><a href="index.html#cmds">Commands</a></li>
	<li><a href="index.html#woks">Hg and chroot Wok</a></li>
	<li><a href="index.html#log">Log files</a></li>
	<li><a href="index.html#web">Web interface</a></li>
	<li><a href="index.html#hg-hook">Hg hook</a></li>
	<li><a href="index.html#cron">Cron Job</a></li>
	<li><a href="index.html#db">Database Files</a></li>
</ul>

<a name="about"></a>
<h3>How it works</h3>
<p>
Tazbb can be run by a cron job and checks the last commit done by contributors
and then cooks the modified packages. Runnning 'tazbb cook-commit' will just
rebuild the last modified packages. To rebuild all missing, modified or unbuilt
packages you must use the 'tazbb cook-all' command.
</p>
<p>
Generating a report will source all the receipts in the wok and check if a package
file exists, if not we add the package name to the current cooklist. For
existing packages we compare all the files' dates in the Hg wok (receipt, stuff)
against the package.tazpkg file date, if it differs we add the package to the cooklist.
</p>
<p>
Tazbb must also look in the chroot wok to check if the package is already built, (there
should be a taz/ directory), if not we log it and add it also to the cooklist.
All packages are cooked with a 'script'. Logs for cooked packages are stored in
$LOG_DIR and a link exists for the web interface so that developers can easily check
for bugs.
</p>
<p>
When run with the option 'cook' - Tazbb will also remove old and corrupted packages
and then execute 'tazwok genlist --text' to rebuild all the packages lists. To work
properly, the Tazwok and Tazbb configured paths must match. The Tazbb system wide 
configuration file is: <code>/etc/slitaz/tazbb.conf</code>
</p>

<a name="cmds"></a>
<h3>Commands</h3>
<p>
Tazbb can be installed on your machine and run manually from the command
line - just type 'tazbb usage' for a list of available functions. Tazbb can be
run in report mode and made to display more information with the '--verbose' option.
</p>

<a name="woks"></a>
<h3>Hg and chroot Wok</h3>
<p>
Tazbb uses 2 woks: a clean Hg wok and a wok to build packages in a chroot environment.
Each time Tazbb is called; the Hg wok is updated and copied to the build
wok, so we avoid messing with build results and can also manually modify 
receipts or patches directly without affecting the main Hg. If configured
correctly 'tazdev update-wok' can also update the Hg wok and copy files.
</p>

<a name="log"></a>
<h3>Log files</h3>
<p>
Tazbb uses existing tools such as tazwok to build packages, but generates its own
log files and has its own database stored in a text file. The log files are
available through the web interface and the default path for the files is:
<code>/var/log/tazbb</code>
</p>

<a name="web"></a>
<h3>Web interface</h3>
<p>
Tazbb logs all its activity to log files and a cooklist. This information
can be displayed through a nice web interface so developers can have a quick
overview of the last build results. The Tazbb package provides a PHP web interface,
CSS stylesheets and images installed by default in <code>/var/lib/tazbb/web</code>.
A symlink is created in <code>/var/www/vhosts</code> by a package, it provides
easy access to the generated log files through a virtual host or you can use:
http://localhost/vhosts/bb
</p>

<a name="hg-hook"></a>
<h3>Hg hook</h3>
<p>
Mercurial offers a powerful mechanism to perform automated actions in response
to events that occur in a repository. The name Mercurial uses for one of these
actions is a hook. So Tazbb can be run each time a commit is done in the wok
through a simple hook in the .hgrc file of the repository. Example:
</p>
<pre class="script">
[hooks]
commit = tazbb cook-commit
</pre>

<a name="cron"></a>
<h3>Cron Job</h3>
<p>
Tazbb can also be run by a cron tab, so each new commit in the wok will cook the
correct package each time you want. Cron can also be used to refresh the report
or run a full cook. If the last cook is not yet finished or if tazbb has been
run by hand (and is still running), it will exit due to a lock file in /var/lock.
Example of a cron job to 'tazbb cook commit' every 2 hours and cook all missing, modified
or unbuilt packages each night:
</p>
<pre class="script">
*/2 * * * * /usr/bin/tazbb cook-commit
03 02 * * * /usr/bin/tazbb cook-all
</pre>

<a name="db"></a>
<h3>Database Files</h3>
<ul>
	<li>blocked    : List of blocked packages</li>
	<li>cooklist   : Current or next cooklist</li>
	<li>corrupted  : Corrupted packages list</li>
	<li>packaged   : All packages from the build wok</li>
	<li>removed    : Last removed packages</li>
	<li>report     : Last report from check_{wok,commit}</li>
	<li>running    : Current task running</li>
	<li>summary    : Last summary for the web interface</li>
	<li>unbuilt    : List of unbuilt packages</li>
</ul>

<!-- End of content -->
</div>

<!-- Footer. -->
<div id="footer">
	<div class="footer-right"></div>
	<a href="index.html#top">Top of the page</a> |
	<a href="index.html">Table of contents</a>
</div>

<div id="copy">
	Copyright &copy; 2009 <a href="http://www.slitaz.org/en/">SliTaz</a> -
	<a href="http://www.gnu.org/licenses/gpl.html">GNU General Public License</a>;<br />
	Documentation is under
	<a href="http://www.gnu.org/copyleft/fdl.html">GNU Free Documentation License</a>
	and code is <a href="http://validator.w3.org/">valid xHTML 1.0</a>.
</div>

</body>
</html>
